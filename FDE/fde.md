# Full Disk Encryption Arch with UEFI - Dual boot Windows

## Setup Machine

### Backup
Backup your data.
Files, Settings, Software, Passwords, Hidden stuff

### Create live USBs
Download Windows Media Creation Tool and setup the USB.

Download RUFUS, for creating a live USB from an ISO.

Download Arch ISO from archlinux.org. Use GPT as the file system.

### Install Windows
Either boot via USB by selecting the boot from USB option in the UEFI menu, 
or go to:

Settings -> Update&Security -> Recovery -> Advanced startup

It's important to note, that you have to **enlarge the ESP**, because initramfs will copy files onto the ESP for the FDE. 
ESP size depends on OS, Windows alone needs less than 100 MB, Arch+FDE alone less than 200 MB, but a system like Debian alone less than 500 MB, so for future ease and just not to be greedy we set 2 GB.
For simple Arch + FDE + Windows it looks like we use 191 MB. But that may increase if we do fancy stuff.

*EDIT: I didn't format the EFI partition, I only created the efi partition, so maybe if you want to use a linux tool try this first.* 
Sadly, using the linux tool for partitioning I ran into problems with Windows installation. Windows recovery partition wasn't created.. 
What worked was using Windows media creation tool: 
- Unallocate all space
- Shift + F10
- diskpart.exe
- list disk
- select disk *n*
- **create partition efi size=X** where X is size in MiB
- **format quick fs=fat32 label=System**
- exit exit
- then refresh
- then create a **new** partition, having unallocated space hovered
- now you should have 1 EFI, 1 Primary Partition, and rest of space is unallocated

### Secure Boot - Hell
**shim** is a verified boot loader, that can launch the GRUB boot loader.

But Archlinux doesn't officially support secure boot, so you'll have to get your hands dirty. You'll have to change the bootloader from the archiso, and add keys generated by yourself to some keyring..

<https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot>




## Planning


### Arch boot process
<https://wiki.archlinux.org/title/Arch_boot_process#Under_UEFI>


### Partitioning
<https://wiki.archlinux.org/title/Partitioning>

Usefull commands:
- `lsblk`
- `fdisk -l` 

Since you've already installed Windows, an **EFI partition already exists**. 
This partition should be mounted and used and not deleted.

We will use one **single root partition** and fully encrypt that root partition. 
The ESP (EFI System Partition) will stay unencrypted. Windows has to look for itself too.

A **swap space** is usefull if RAM runs out, or you want to hibernate. 
A seperate swap partition is probably not needed and a simple swap file should be enough. 
Hibernation is storing the state of the system to the disk (suspend to disk) and then shutting off the machine, so that 0 energy gets consumed.

We will use GPT file system.

#### EFI system partition
<https://wiki.archlinux.org/title/EFI_system_partition>


### GRUB 2
<https://wiki.archlinux.org/title/GRUB>

GRUB 2 aka GRUB (GRUB 1 = GRUB legacy) can be used as a bootloader.

We configure the GRUB in **/etc/default/grub** and will run 
**grub-mkconfig -o /boot/grub/grub.cfg** to create the real config file.

Using /etc/default is usefull since when reinstalling grub, your config files will remain in /etc/default.


## FDE
<https://wiki.archlinux.org/title/Dm-crypt/Encrypting_an_entire_system>

<https://youtube.com/watch?v=XNJ4oKla8B0>

Once we have created the partition for our Linux os, we will encrypt it, then decrypt it for editing. 
We will then create a file system and create the swap file etc.

It's important to note that we will have to alter the initramfs stage, i.e. add hooks to our mkinitcpio config file, in order to load tools for decrypting our drive and receiving the correct keyboard input.




## Installation
<https://wiki.archlinux.org/title/Installation_guide>

*Note: we'll switch between Instalation Guide, Dm-crypt/Encrypting_an_entire_system, and the Youtube Video*


### Basics
- `loadkeys de_CH-latin1`
- `setfont ter-120b` or `setfont ter-132b`
- (fonts in: /usr/share/kbd/consolefonts)
- ping archlinux.org (if not connected, get internet access)
- `timedatectl`
- `timedatectl set-timezone Europe/Zurich`


### Partitioning
- ESP and Windows partitions already done
- fdisk or gdisk can be used
- then encrypt the partition to be used
- **cryptsetup -y -v luksFormat /dev/sdaX** where X is nr of partition
- decrypt: **cryptsetup open /dev/sdaX NAME** where name can be cryptroot, X is your partition
- decrypted device (kind of a virtual thing) is located at **/dev/mapper/NAME**
- from now on we have sda5 and cryptroot as the partition we're referring to
- format: **mkfs.ext4 /dev/mapper/cryptroot**


### Mounting
- **mount /dev/mapper/cryptroot /mnt**
- **mount --mkdir /dev/sda1 /mnt/boot**


### Installing Essentials
- **pacstrap -K /mnt base linux linux-firmware neovim ..** where .. can contain the following:
- intel-ucode man-db networkmanager
- and tlp for latop battery usage performance increase


### Configure the System
- we'll generate fstab after swapfile creation, so it's included
- leave installer, enter installation: **arch-chroot /mnt**
- *Note, the installation is currently mounted in the installer at /mnt*
- create swapfile (used for hybernation or extra ram) *(swap partition would be the alternative, had to be done earlier)*
- **fallocate -l 4GB /swapfile**
- **chmod 600 /swapfile** (only root can read and edit)
- **mkswap /swapfile**
- **swapon /swapfile**
- **exit**
- generate filesystem table: **genfstab -U /mnt >> /mnt/etc/fstab**
- **arch-chroot /mnt**
- **ln -sf /usr/share/zoneinfo/Europe/Zurich /etc/localtime**
- **hwclock --systohc**
- **nvim /etc/locale.gen**
- uncomment your locales + **en_US.UTF-8**
- **echo LANG=en_US.UT-F8 >> etc/locale.conf**
- **echo KEYMAP=de_CH-latin1 >> etc/vconsole.conf**
- **nvim /etc/hostname** add your hostname
- install grub and extras
- **pacman -S grub efibootmgr dosfstools base-devel git**
- **nvim /etc/mkinitcpio.conf**
- **HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block encrypt filesystems fsck)**
- **du -sh /boot** shows size of ESP I think. Mine is 191 MB during the install


### GRUB Install
- **grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB**
- **grub-mkconfig -o /boot/grub/grub.cfg**
- to make grub find other OSes, download os-prober, and edit **GRUB_DISABLE_OS_PROBER=true**, and remake the config file
- **blkid**
- get UUID from the encrypted device, copy it
- in /etc/default/grub edit the line **GRUB_CMDLINE_LINUX=""**,
- and add **cryptdevice=UUID=PASTEITHERE:cryptroot root=/dev/mapper/cryptroot**


### Enable services
- systemctl enable NetworkManager


### GNOME
- sudo pacman -S gnome
- systemctl enable gdm.service
- localectl set-x11-keymap ch 
- set your main monitor in settings of gnome,
- then: cp ~/.config/monitors.xml ~gdm/.config/monitors.xml
- chown gdm:gdm ~gdm/.config/monitors.xml
